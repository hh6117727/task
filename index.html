<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des T√¢ches</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen font-sans antialiased p-4 sm:p-6 flex items-center justify-center">
  <div class="max-w-3xl w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">

    <!-- Zone de messages pour l'utilisateur -->
    <div id="message-box" class="hidden"></div>

    <!-- Section de Connexion -->
    <div id="login-section">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üîê Gestion des T√¢ches - Connexion</h1>
      <div class="space-y-4">
        <input id="username-input" placeholder="Nom d'utilisateur" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-2">
        <input type="password" id="password-input" placeholder="Mot de passe" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
        <button onclick="login()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Se connecter
        </button>
      </div>
    </div>

    <!-- Section Admin -->
    <div id="admin-section" class="hidden">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üë®‚Äçüíº Admin - Gestion des T√¢ches</h1>
      
      <div id="admin-user-info-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-blue-50 rounded-md">
        Connect√© en tant que: <span id="admin-current-username"></span>
      </div>

      <!-- Sous-section Ajouter une t√¢che -->
      <div class="space-y-4 mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
        <h2 class="text-2xl font-bold text-gray-700">Ajouter une t√¢che</h2>
        <input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="Technicien (ex: John)" id="tech" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="T√¢che (ex: R√©parer l'imprimante)" id="task" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
        <button id="add-task-button" onclick="ajouterTache()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Ajouter
        </button>
      </div>

      <!-- Sous-section Toutes les t√¢ches -->
      <div class="space-y-4 mt-8">
        <h3 class="text-2xl font-bold text-gray-700">üìã Toutes les T√¢ches</h3>
        <ul id="all-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Chargement des t√¢ches...</li>
        </ul>
      </div>

      <!-- Bouton pour acc√©der √† la configuration des comptes -->
      <button onclick="showPage('config-section'); chargerUtilisateurs();" 
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg mt-6">
        G√©rer les comptes
      </button>

      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Aller √† la page de connexion
      </button>
    </div>

    <!-- Section de Configuration des Comptes -->
    <div id="config-section" class="hidden">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">‚öôÔ∏è Configuration des Comptes</h1>
      
      <div class="space-y-4 mb-8 p-6 bg-purple-50 rounded-lg shadow-inner">
        <h2 class="text-2xl font-bold text-gray-700">Ajouter un nouveau compte</h2>
        <input id="new-username-input" placeholder="Nom d'utilisateur" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-2">
        <input type="password" id="new-password-input" placeholder="Mot de passe" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-2">
        <select id="new-role-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
          <option value="technicien">Technicien</option>
          <option value="admin">Admin</option>
        </select>
        <button onclick="ajouterUtilisateur()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Ajouter utilisateur
        </button>
      </div>

      <div class="space-y-4 mt-8">
        <h3 class="text-2xl font-bold text-gray-700">Liste des utilisateurs</h3>
        <ul id="users-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Chargement des utilisateurs...</li>
        </ul>
        <button onclick="supprimerUtilisateur()"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg mt-4">
          Supprimer l'utilisateur s√©lectionn√©
        </button>
      </div>

      <button onclick="showPage('admin-section')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Retour √† l'Admin
      </button>
    </div>


    <!-- Section Utilisateur -->
    <div id="user-section" class="hidden">
      <h1 id="user-page-title" class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üë∑‚Äç‚ôÇÔ∏è Technicien - Mes T√¢ches</h1>

      <div id="tech-user-info-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-green-50 rounded-md">
        Connect√© en tant que: <span id="tech-current-username"></span>
      </div>

      <div class="space-y-4 mt-8 p-6 bg-green-50 rounded-lg shadow-inner">
        <h3 class="text-2xl font-bold text-gray-700">Mes T√¢ches</h3>
        <ul id="my-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Chargement des t√¢ches...</li>
        </ul>
      </div>
      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Aller √† la page de connexion
      </button>
    </div>

  </div>

  <script>
    // ‚ö†Ô∏è IMPORTANT: CECI EST L'URL DE VOTRE APPLICATION WEB GOOGLE APPS SCRIPT D√âPLOY√âE
    const API_URL = "https://script.google.com/macros/s/AKfycbx5y0EBJsrw0uTtwFA_l0ONy3fBT5cbZs3qhJVUnNdLUDPyZFb_xZIpJLWiXF4KO-L3/exec";

    let currentUsername = ""; // Stocke le nom d'utilisateur actuellement connect√©
    let currentUserRole = ""; // Stocke le r√¥le de l'utilisateur actuellement connect√© (admin/technicien)
    let selectedUserToDelete = null; // Utilisateur s√©lectionn√© dans la liste de configuration

    // --- Fonctions utilitaires ---

    // Fonction pour afficher les messages √† l'utilisateur
    function showMessage(message, type = "info") {
      const messageBox = document.getElementById('message-box');
      messageBox.innerText = message;
      messageBox.className = 'p-3 rounded-lg text-center mt-4'; // R√©initialiser les classes
      if (type === "success") {
        messageBox.classList.add('bg-green-100', 'text-green-800');
      } else if (type === "error") {
        messageBox.classList.add('bg-red-100', 'text-red-800');
      } else { // info
        messageBox.classList.add('bg-blue-100', 'text-blue-800');
      }
      messageBox.classList.remove('hidden');
      // Cacher le message apr√®s quelques secondes
      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 5000);
    }

    // Fonction pour afficher une section sp√©cifique
    function showPage(pageId) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById('config-section').classList.add('hidden'); // Cacher la section config aussi

      document.getElementById(pageId).classList.remove('hidden');
      document.getElementById('message-box').classList.add('hidden'); // Cacher le message lors du changement de page
    }

    // --- Logique de connexion ---
    window.login = async function() {
      currentUsername = document.getElementById("username-input").value.toLowerCase().trim();
      const password = document.getElementById("password-input").value.trim();

      if (currentUsername === "" || password === "") {
        showMessage("Veuillez entrer un nom d'utilisateur et un mot de passe.", "error");
        return;
      }

      try {
        const response = await fetch(API_URL + "?action=login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: currentUsername, password: password })
        });
        const result = await response.json(); // Le backend doit retourner du JSON pour la connexion

        if (response.ok && result.success) {
          currentUserRole = result.role;
          // Mettre √† jour l'affichage du nom d'utilisateur dans les sections
          document.getElementById('admin-current-username').innerText = currentUsername;
          document.getElementById('tech-current-username').innerText = currentUsername;

          if (currentUserRole === "admin") {
            showPage('admin-section');
            chargerToutesTaches(); // Charger toutes les t√¢ches pour l'admin
          } else { // Role technicien
            document.getElementById('user-page-title').innerText = `üë∑‚Äç‚ôÇÔ∏è T√¢ches pour ${currentUsername.charAt(0).toUpperCase() + currentUsername.slice(1)}`;
            showPage('user-section');
            chargerMesTaches(currentUsername); // Charger les t√¢ches pour le technicien sp√©cifique
          }
          showMessage(`Bienvenue, ${currentUsername}!`, "success");
        } else {
          showMessage("Nom d'utilisateur ou mot de passe incorrect.", "error");
        }
      } catch (e) {
        console.error("Erreur r√©seau ou script lors de la connexion: ", e);
        showMessage("Erreur r√©seau. Impossible de se connecter.", "error");
      }
    };

    // --- Fonctions de gestion des t√¢ches ---

    // Ajouter une nouvelle t√¢che √† la feuille Google
    window.ajouterTache = async function() {
      const dateInput = document.getElementById('date');
      const techInput = document.getElementById('tech');
      const taskInput = document.getElementById('task');

      const taskData = {
        date: dateInput.value,
        tech: techInput.value,
        task: taskInput.value
      };

      if (!taskData.date || !taskData.tech || !taskData.task) {
        showMessage("Veuillez remplir tous les champs (Date, Technicien, T√¢che).", "error");
        return;
      }

      try {
        const response = await fetch(API_URL + "?action=add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(taskData)
        });
        const result = await response.text(); // Votre Apps Script renvoie du texte brut
        if (response.ok) {
          showMessage("T√¢che ajout√©e avec succ√®s!", "success");
          dateInput.value = ''; // Effacer les champs
          techInput.value = '';
          taskInput.value = '';
          chargerToutesTaches(); // Actualiser la liste des t√¢ches de l'admin
        } else {
          console.error("Erreur lors de l'ajout de la t√¢che:", result);
          showMessage("Erreur lors de l'ajout de la t√¢che: " + result, "error");
        }
      } catch (e) {
        console.error("Erreur r√©seau ou script lors de l'ajout de la t√¢che: ", e);
        showMessage("Erreur r√©seau. Impossible d'ajouter la t√¢che.", "error");
      }
    };

    // Charger toutes les t√¢ches pour la section Admin
    async function chargerToutesTaches() {
      const ul = document.getElementById("all-tasks-list");
      ul.innerHTML = '<li class="text-gray-500 text-center p-4">Chargement de toutes les t√¢ches...</li>'; // Afficher le chargement

      try {
        const response = await fetch(API_URL + "?action=list", { method: "POST" });
        const data = await response.json(); // Votre Apps Script renvoie du JSON

        ul.innerHTML = ""; // Effacer les √©l√©ments de liste existants

        // Filtrer la ligne d'en-t√™te (premier √©l√©ment) et afficher les t√¢ches
        data.slice(1).forEach(row => {
          const li = document.createElement("li");
          li.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
          // Format de ligne suppos√©: [Date, Technicien, T√¢che, Statut]
          li.innerHTML = `
            <div class="flex-grow">
              <p class="font-semibold text-blue-700">${row[0] || 'N/A'} | ${row[1] || 'N/A'}</p>
              <p class="text-gray-800">${row[2] || 'N/A'}</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
              Statut: <span class="font-bold ${row[3] === 'Fait' ? 'text-green-600' : 'text-red-600'}">${row[3] || 'N/A'}</span>
            </div>
          `;
          ul.appendChild(li);
        });

        if (data.length <= 1) { // Seulement la ligne d'en-t√™te ou aucune donn√©e
          ul.innerHTML = '<li class="text-gray-500 text-center p-4">Aucune t√¢che trouv√©e.</li>';
        }
      } catch (e) {
        console.error("Erreur lors du chargement de toutes les t√¢ches: ", e);
        showMessage("Erreur lors du chargement de toutes les t√¢ches. V√©rifiez la console.", "error");
        ul.innerHTML = '<li class="text-red-500 text-center p-4">√âchec du chargement des t√¢ches.</li>';
      }
    }

    // Charger les t√¢ches pour un technicien sp√©cifique
    async function chargerMesTaches(user) {
      const ul = document.getElementById("my-tasks-list");
      ul.innerHTML = '<li class="text-gray-500 text-center p-4">Chargement de vos t√¢ches...</li>'; // Afficher le chargement

      try {
        // Appel mis √† jour pour r√©cup√©rer les donn√©es avec l'index de ligne d'origine
        const response = await fetch(API_URL + "?action=userTasks&tech=" + encodeURIComponent(user), { method: "POST" });
        const tasks = await response.json(); // S'attend maintenant √† un tableau d'objets

        ul.innerHTML = ""; // Effacer les √©l√©ments de liste existants

        tasks.forEach(task => {
          const li = document.createElement("li");
          li.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
          
          li.innerHTML = `
            <div class="flex-grow">
              <p class="font-semibold text-green-700">${task.date || 'N/A'}</p>
              <p class="text-gray-800">${task.task || 'N/A'}</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
              Statut: <span class="font-bold ${task.status === 'Fait' ? 'text-green-600' : 'text-red-600'}">${task.status || 'N/A'}</span>
            </div>
          `;
          
          if (task.status !== "Fait") {
            const btn = document.createElement("button");
            btn.innerText = "‚úÖ Terminer";
            btn.className = 'ml-4 bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-full text-sm transition duration-300 ease-in-out';
            // Utiliser l'index de ligne d'origine de la r√©ponse de l'Apps Script
            btn.onclick = async () => {
              await markTaskDone(task.rowIndex);
              chargerMesTaches(user); // Actualiser les t√¢ches du technicien apr√®s avoir marqu√© comme termin√©
            };
            li.appendChild(btn);
          }
          ul.appendChild(li);
        });

        if (tasks.length === 0) {
          ul.innerHTML = '<li class="text-gray-500 text-center p-4">Aucune t√¢che ne vous est assign√©e.</li>';
        }
      } catch (e) {
        console.error("Erreur lors du chargement des t√¢ches du technicien: ", e);
        showMessage("Erreur lors du chargement de vos t√¢ches. V√©rifiez la console.", "error");
        ul.innerHTML = '<li class="text-red-500 text-center p-4">√âchec du chargement des t√¢ches.</li>';
      }
    }

    // Marquer la t√¢che comme termin√©e
    window.markTaskDone = async function(rowIndex) {
      try {
        const response = await fetch(API_URL + "?action=done&row=" + rowIndex, { method: "POST" });
        const result = await response.text();
        if (response.ok) {
          showMessage("T√¢che marqu√©e comme termin√©e!", "success");
        } else {
          console.error("Erreur lors du marquage de la t√¢che comme termin√©e:", result);
          showMessage("Erreur lors du marquage de la t√¢che comme termin√©e: " + result, "error");
        }
      } catch (e) {
        console.error("Erreur r√©seau ou script lors du marquage de la t√¢che comme termin√©e: ", e);
        showMessage("Erreur r√©seau. Impossible de marquer la t√¢che comme termin√©e.", "error");
      }
    };

    // --- Fonctions de gestion des utilisateurs (Nouvelles) ---

    // Ajouter un nouvel utilisateur
    window.ajouterUtilisateur = async function() {
      const username = document.getElementById("new-username-input").value.toLowerCase().trim();
      const password = document.getElementById("new-password-input").value.trim();
      const role = document.getElementById("new-role-select").value;

      if (!username || !password || !role) {
        showMessage("Veuillez remplir tous les champs pour le nouvel utilisateur.", "error");
        return;
      }

      try {
        const response = await fetch(API_URL + "?action=addUser", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role })
        });
        const result = await response.text();
        if (response.ok) {
          showMessage("Utilisateur ajout√© avec succ√®s!", "success");
          document.getElementById("new-username-input").value = "";
          document.getElementById("new-password-input").value = "";
          chargerUtilisateurs(); // Actualiser la liste des utilisateurs
        } else {
          console.error("Erreur lors de l'ajout de l'utilisateur:", result);
          showMessage("Erreur lors de l'ajout de l'utilisateur: " + result, "error");
        }
      } catch (e) {
        console.error("Erreur r√©seau ou script lors de l'ajout de l'utilisateur: ", e);
        showMessage("Erreur r√©seau. Impossible d'ajouter l'utilisateur.", "error");
      }
    };

    // Supprimer un utilisateur s√©lectionn√©
    window.supprimerUtilisateur = async function() {
      if (!selectedUserToDelete) {
        showMessage("Veuillez s√©lectionner un utilisateur √† supprimer.", "error");
        return;
      }
      
      // Confirmation avant suppression (remplacer par une modale custom si alert n'est pas permis)
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${selectedUserToDelete}" ?`)) {
          return;
      }

      try {
        const response = await fetch(API_URL + "?action=deleteUser", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: selectedUserToDelete })
        });
        const result = await response.text();
        if (response.ok) {
          showMessage("Utilisateur supprim√© avec succ√®s!", "success");
          selectedUserToDelete = null; // R√©initialiser la s√©lection
          chargerUtilisateurs(); // Actualiser la liste des utilisateurs
        } else {
          console.error("Erreur lors de la suppression de l'utilisateur:", result);
          showMessage("Erreur lors de la suppression de l'utilisateur: " + result, "error");
        }
      } catch (e) {
        console.error("Erreur r√©seau ou script lors de la suppression de l'utilisateur: ", e);
        showMessage("Erreur r√©seau. Impossible de supprimer l'utilisateur.", "error");
      }
    };

    // Charger la liste des utilisateurs pour la configuration
    async function chargerUtilisateurs() {
      const ul = document.getElementById("users-list");
      ul.innerHTML = '<li class="text-gray-500 text-center p-4">Chargement des utilisateurs...</li>';

      try {
        const response = await fetch(API_URL + "?action=listUsers", { method: "POST" });
        const users = await response.json(); // S'attend √† un tableau d'objets {username, password, role}

        ul.innerHTML = "";
        if (users.length === 0) {
          ul.innerHTML = '<li class="text-gray-500 text-center p-4">Aucun utilisateur trouv√©.</li>';
          return;
        }

        const dataToDisplay = users; // The Apps Script now returns structured objects

        dataToDisplay.forEach(user => {
            const username = user.username || 'N/A';
            const role = user.role || 'N/A';
            
            const li = document.createElement("li");
            li.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col justify-between items-start cursor-pointer hover:bg-gray-200';
            li.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800">Nom d'utilisateur: ${username}</p>
                    <p class="text-sm text-gray-600">R√¥le: ${role.charAt(0).toUpperCase() + role.slice(1)}</p>
                </div>
            `;
            li.onclick = () => {
                // Mettre en surbrillance l'√©l√©ment s√©lectionn√©
                document.querySelectorAll('#users-list li').forEach(item => {
                    item.classList.remove('border-2', 'border-purple-500');
                });
                li.classList.add('border-2', 'border-purple-500');
                selectedUserToDelete = username;
            };
            ul.appendChild(li);
        });

      } catch (e) {
        console.error("Erreur lors du chargement des utilisateurs: ", e);
        showMessage("Erreur lors du chargement des utilisateurs. V√©rifiez la console.", "error");
        ul.innerHTML = '<li class="text-red-500 text-center p-4">√âchec du chargement des utilisateurs.</li>';
      }
    }


    // --- Chargement initial ---
    window.onload = function() {
      showPage('login-section'); // Toujours commencer par la page de connexion
    };

    // --- Fonction de d√©connexion ---
    window.goToLogin = function() {
      currentUsername = ""; // Effacer le nom d'utilisateur connect√©
      currentUserRole = ""; // Effacer le r√¥le
      document.getElementById("username-input").value = ""; // Effacer le champ de saisie
      document.getElementById("password-input").value = ""; // Effacer le champ de mot de passe
      showPage('login-section');
      showMessage("D√©connect√© avec succ√®s.", "info");
    };
  </script>
</body>
</html>
