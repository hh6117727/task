<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Tâches</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div id="login" class="max-w-md mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Connexion</h2>
    <input id="username" type="text" placeholder="Nom d'utilisateur" class="w-full p-2 border mb-2">
    <input id="password" type="password" placeholder="Mot de passe" class="w-full p-2 border mb-4">
    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Se connecter</button>
    <p id="loginError" class="text-red-500 mt-2 hidden">Identifiants incorrects.</p>
  </div>

  <div id="dashboard" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Bienvenue, <span id="userLabel"></span></h2>
    <div id="tasks" class="mb-4"></div>
    <div id="adminPanel" class="hidden">
      <h3 class="font-semibold">Ajouter une tâche</h3>
      <input id="newDate" type="date" class="border p-1 m-1">
      <input id="newTech" type="text" placeholder="Technicien" class="border p-1 m-1">
      <input id="newTask" type="text" placeholder="Tâche" class="border p-1 m-1">
      <button onclick="addTask()" class="bg-green-500 text-white px-2 py-1 rounded">Ajouter</button>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyv0x9_hqiZw1ZoqAb5mpsYU-CZr_nZJGSUF_XcKRqRkBVpWAYX-e40nilVZEpdg1Wk/exec"; // Remplacez avec votre URL de script

    let currentUser = "", currentRole = "";

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ action: "login", username, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          currentUser = username;
          currentRole = data.role;
          document.getElementById("login").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
          document.getElementById("userLabel").textContent = username;
          if (currentRole == "admin") {
            document.getElementById("adminPanel").classList.remove("hidden");
          }
          loadTasks();
        } else {
          document.getElementById("loginError").classList.remove("hidden");
        }
      });
    }

    function loadTasks() {
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ action: "getTasks", username: currentUser })
      })
      .then(res => res.json())
      .then(tasks => {
        let html = "<h3 class='font-bold mb-2'>Mes Tâches</h3>";
        tasks.forEach(t => {
          html += `<div class='bg-white p-2 mb-1 rounded shadow'>
                     <strong>${t.date}</strong> - ${t.tache} (${t.statut})
                     ${currentRole === "technicien" && t.statut === "En attente" ? 
                       `<button onclick="markDone('${t.tache}')" class="ml-2 text-green-600">✔ Terminer</button>` : ""}
                   </div>`;
        });
        document.getElementById("tasks").innerHTML = html;
      });
    }

    function addTask() {
      const date = document.getElementById("newDate").value;
      const technicien = document.getElementById("newTech").value;
      const tache = document.getElementById("newTask").value;

      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ action: "addTask", date, technicien, tache })
      })
      .then(res => res.json())
      .then(() => {
        loadTasks();
        document.getElementById("newDate").value = "";
        document.getElementById("newTech").value = "";
        document.getElementById("newTask").value = "";
      });
    }

    function markDone(tache) {
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ action: "updateStatus", tache })
      })
      .then(() => loadTasks());
    }
  </script>
</body>
</html>
