<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Tâches</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // Global variables provided by the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase instances and user state
    let app;
    let db;
    let auth;
    let currentUserId = null; // Stores the current authenticated user's UID
    let currentUsername = ""; // Stores the username entered on the login screen

    // --- Firebase Initialization ---
    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in user (anonymously or with custom token if available)
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
          console.log("Signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("Signed in anonymously.");
        }

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUserId = user.uid;
            console.log("Firebase User ID:", currentUserId);
            // Display user ID on relevant sections
            document.getElementById('admin-user-id-display').innerText = `Your Firebase User ID: ${currentUserId}`;
            document.getElementById('tech-user-id-display').innerText = `Your Firebase User ID: ${currentUserId}`;
            // Set up real-time listener for tasks once authenticated
            setupRealtimeTasksListener();
          } else {
            currentUserId = null;
            console.log("No Firebase user signed in.");
            document.getElementById('admin-user-id-display').innerText = `Your Firebase User ID: Not signed in`;
            document.getElementById('tech-user-id-display').innerText = `Your Firebase User ID: Not signed in`;
          }
        });
      } catch (error) {
        console.error("Error initializing Firebase or signing in:", error);
        showMessage("Failed to initialize Firebase. Check console for details.", "error");
      }
    }

    // --- Utility Functions ---

    // Function to display messages to the user
    function showMessage(message, type = "info") {
      const messageBox = document.getElementById('message-box');
      messageBox.innerText = message;
      messageBox.className = 'p-3 rounded-lg text-center mt-4'; // Reset classes
      if (type === "success") {
        messageBox.classList.add('bg-green-100', 'text-green-800');
      } else if (type === "error") {
        messageBox.classList.add('bg-red-100', 'text-red-800');
      } else { // info
        messageBox.classList.add('bg-blue-100', 'text-blue-800');
      }
      messageBox.classList.remove('hidden');
      // Hide message after a few seconds
      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 5000);
    }

    // Function to show a specific page (section)
    function showPage(pageId) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById(pageId).classList.remove('hidden');
      document.getElementById('message-box').classList.add('hidden'); // Hide message on page change
    }

    // --- Login Logic ---
    window.login = function() {
      currentUsername = document.getElementById("username-input").value.toLowerCase().trim(); // Use a unique ID
      if (currentUsername === "") {
        showMessage("Please enter a username.", "error");
        return;
      }

      if (currentUsername === "admin") {
        showPage('admin-section');
        // No need to reload, real-time listener handles updates
      } else {
        document.getElementById('user-page-title').innerText = `👷‍♂️ Tâches pour ${currentUsername.charAt(0).toUpperCase() + currentUsername.slice(1)}`;
        showPage('user-section');
        // No need to reload, real-time listener handles updates
      }
      showMessage(`Welcome, ${currentUsername}!`, "success");
    };

    // --- Task Management Functions ---

    // Add a new task to Firestore
    window.ajouterTache = async function() {
      if (!db || !currentUserId) {
        showMessage("Database not ready. Please try again.", "error");
        return;
      }

      const dateInput = document.getElementById('date');
      const techInput = document.getElementById('tech');
      const taskInput = document.getElementById('task');

      const taskData = {
        date: dateInput.value,
        tech: techInput.value,
        task: taskInput.value,
        userId: currentUserId, // User who added the task
        status: "En cours", // Default status
        createdAt: new Date() // Timestamp for ordering
      };

      if (!taskData.date || !taskData.tech || !taskData.task) {
        showMessage("Please fill in all fields (Date, Technician, Task).", "error");
        return;
      }

      try {
        // Store public data in /artifacts/{appId}/public/data/tasks
        const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
        await addDoc(tasksCollectionRef, taskData);
        showMessage("Task added successfully!", "success");
        // Clear inputs
        dateInput.value = '';
        techInput.value = '';
        taskInput.value = '';
      } catch (e) {
        console.error("Error adding document: ", e);
        showMessage("Error adding task. See console for details.", "error");
      }
    };

    // Update task status to "Fait" (Done)
    window.markTaskDone = async function(taskId) {
      if (!db) {
        showMessage("Database not ready. Cannot mark task as done.", "error");
        return;
      }
      try {
        const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
        await updateDoc(taskDocRef, {
          status: "Fait",
          completedAt: new Date()
        });
        showMessage("Task marked as completed!", "success");
      } catch (e) {
        console.error("Error updating document: ", e);
        showMessage("Error marking task as done. See console for details.", "error");
      }
    };

    // Set up real-time listener for tasks
    function setupRealtimeTasksListener() {
      if (!db) {
        console.error("Firestore not initialized for listener. Cannot set up listener.");
        return;
      }

      const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
      const q = query(tasksCollectionRef); // Fetch all tasks

      onSnapshot(q, (snapshot) => {
        const allTasksUl = document.getElementById("all-tasks-list");
        const myTasksUl = document.getElementById("my-tasks-list");

        // Clear existing lists
        allTasksUl.innerHTML = '';
        myTasksUl.innerHTML = '';

        const fetchedTasks = [];
        snapshot.forEach((doc) => {
          fetchedTasks.push({ id: doc.id, ...doc.data() });
        });

        // Sort tasks by creation date (newest first)
        fetchedTasks.sort((a, b) => (b.createdAt?.toDate()?.getTime() || 0) - (a.createdAt?.toDate()?.getTime() || 0));

        fetchedTasks.forEach((task) => {
          // Display for Admin Section (all tasks)
          const adminLi = document.createElement("li");
          adminLi.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
          adminLi.innerHTML = `
            <div class="flex-grow">
              <p class="font-semibold text-blue-700">${task.date || 'N/A'} | ${task.tech || 'N/A'}</p>
              <p class="text-gray-800">${task.task || 'N/A'}</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
              Status: <span class="font-bold ${task.status === 'Fait' ? 'text-green-600' : 'text-red-600'}">${task.status || 'N/A'}</span> <br>
              Added by: ${task.userId || 'N/A'}
            </div>
          `;
          allTasksUl.appendChild(adminLi);

          // Display for User Section (filtered by technician)
          if (currentUsername && task.tech && task.tech.toLowerCase() === currentUsername.toLowerCase()) {
            const userLi = document.createElement("li");
            userLi.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
            userLi.innerHTML = `
              <div class="flex-grow">
                <p class="font-semibold text-green-700">${task.date || 'N/A'}</p>
                <p class="text-gray-800">${task.task || 'N/A'}</p>
              </div>
              <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
                Status: <span class="font-bold ${task.status === 'Fait' ? 'text-green-600' : 'text-red-600'}">${task.status || 'N/A'}</span>
              </div>
            `;
            if (task.status !== "Fait") {
              const markDoneBtn = document.createElement("button");
              markDoneBtn.innerText = "✅ Terminer";
              markDoneBtn.className = 'ml-4 bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-full text-sm transition duration-300 ease-in-out';
              markDoneBtn.onclick = () => window.markTaskDone(task.id);
              userLi.appendChild(markDoneBtn);
            }
            myTasksUl.appendChild(userLi);
          }
        });
        console.log("Tasks lists updated in real-time.");
      }, (error) => {
        console.error("Error listening to tasks:", error);
        showMessage("Error loading tasks. See console for details.", "error");
      });
    }

    // --- Initial Load ---
    window.onload = function() {
      initializeFirebase(); // Initialize Firebase when the page loads
      showPage('login-section'); // Start with the login page
    };

    // --- Logout Function ---
    window.goToLogin = function() {
      currentUsername = ""; // Clear logged-in username
      document.getElementById("username-input").value = ""; // Clear input field
      showPage('login-section');
      showMessage("Logged out successfully.", "info");
    };
  </script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen font-sans antialiased p-4 sm:p-6 flex items-center justify-center">
  <div class="max-w-3xl w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">

    <!-- Message Box for user feedback -->
    <div id="message-box" class="hidden"></div>

    <!-- Login Section -->
    <div id="login-section">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">🔐 Task Management Login</h1>
      <div class="space-y-4">
        <input id="username-input" placeholder="Nom d'utilisateur (e.g., admin, john, jane)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
        <button onclick="login()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Se connecter
        </button>
      </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="hidden">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">👨‍💼 Admin - Gestion des Tâches</h1>
      
      <div id="admin-user-id-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-blue-50 rounded-md">
        Your Firebase User ID: Loading...
      </div>

      <div class="space-y-4 mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
        <h2 class="text-2xl font-bold text-gray-700">Ajouter une tâche</h2>
        <input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="Technicien (e.g., John)" id="tech" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="Tâche (e.g., Fix Printer)" id="task" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
        <button onclick="ajouterTache()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Ajouter
        </button>
      </div>

      <div class="space-y-4 mt-8">
        <h3 class="text-2xl font-bold text-gray-700">📋 Toutes les Tâches</h3>
        <ul id="all-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Loading tasks...</li>
        </ul>
      </div>
      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Go to Login Page
      </button>
    </div>

    <!-- User Section -->
    <div id="user-section" class="hidden">
      <h1 id="user-page-title" class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">👷‍♂️ Technicien - Mes Tâches</h1>

      <div id="tech-user-id-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-green-50 rounded-md">
        Your Firebase User ID: Loading...
      </div>

      <div class="space-y-4 mt-8 p-6 bg-green-50 rounded-lg shadow-inner">
        <h3 class="text-2xl font-bold text-gray-700">Mes Tâches</h3>
        <ul id="my-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Loading tasks...</li>
        </ul>
      </div>
      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Go to Login Page
      </button>
    </div>

  </div>
</body>
</html>
