<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des T√¢ches</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen font-sans antialiased p-4 sm:p-6 flex items-center justify-center">
  <div class="max-w-3xl w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">

    <!-- Message Box for user feedback -->
    <div id="message-box" class="hidden"></div>

    <!-- Login Section -->
    <div id="login-section">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üîê Task Management Login</h1>
      <div class="space-y-4">
        <input id="username-input" placeholder="Nom d'utilisateur (e.g., admin, john, jane)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
        <button onclick="login()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Se connecter
        </button>
      </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="hidden">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üë®‚Äçüíº Admin - Gestion des T√¢ches</h1>
      
      <!-- User ID Display (can be removed if not using Firebase Auth) -->
      <div id="admin-user-info-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-blue-50 rounded-md">
        Logged in as: <span id="admin-current-username"></span>
      </div>

      <div class="space-y-4 mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
        <h2 class="text-2xl font-bold text-gray-700">Ajouter une t√¢che</h2>
        <input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="Technicien (e.g., John)" id="tech" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
        <input placeholder="T√¢che (e.g., Fix Printer)" id="task" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
        <button id="add-task-button" onclick="ajouterTache()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
          Ajouter
        </button>
      </div>

      <div class="space-y-4 mt-8">
        <h3 class="text-2xl font-bold text-gray-700">üìã Toutes les T√¢ches</h3>
        <ul id="all-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Loading tasks...</li>
        </ul>
      </div>
      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Go to Login Page
      </button>
    </div>

    <!-- User Section -->
    <div id="user-section" class="hidden">
      <h1 id="user-page-title" class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-8">üë∑‚Äç‚ôÇÔ∏è Technicien - Mes T√¢ches</h1>

      <!-- User ID Display (can be removed if not using Firebase Auth) -->
      <div id="tech-user-info-display" class="text-sm text-center text-gray-600 mb-4 p-2 bg-green-50 rounded-md">
        Logged in as: <span id="tech-current-username"></span>
      </div>

      <div class="space-y-4 mt-8 p-6 bg-green-50 rounded-lg shadow-inner">
        <h3 class="text-2xl font-bold text-gray-700">Mes T√¢ches</h3>
        <ul id="my-tasks-list" class="space-y-3">
          <li class="text-gray-500 text-center p-4">Loading tasks...</li>
        </ul>
      </div>
      <button onclick="goToLogin()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out mt-6">
        Go to Login Page
      </button>
    </div>

  </div>

  <script>
    // ‚ö†Ô∏è IMPORTANT: THIS IS YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL
    const API_URL = "https://script.google.com/macros/s/AKfycbxPjOW0W8sn932N3RGVjOmCMxTyDT_aQfm6tMVPbSe2Q7FTDI0oEl_4I0r9IlWr-Ra2/exec";

    let currentUsername = ""; // Stores the username entered on the login screen

    // --- Utility Functions ---

    // Function to display messages to the user
    function showMessage(message, type = "info") {
      const messageBox = document.getElementById('message-box');
      messageBox.innerText = message;
      messageBox.className = 'p-3 rounded-lg text-center mt-4'; // Reset classes
      if (type === "success") {
        messageBox.classList.add('bg-green-100', 'text-green-800');
      } else if (type === "error") {
        messageBox.classList.add('bg-red-100', 'text-red-800');
      } else { // info
        messageBox.classList.add('bg-blue-100', 'text-blue-800');
      }
      messageBox.classList.remove('hidden');
      // Hide message after a few seconds
      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 5000);
    }

    // Function to show a specific page (section)
    function showPage(pageId) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById(pageId).classList.remove('hidden');
      document.getElementById('message-box').classList.add('hidden'); // Hide message on page change
    }

    // --- Login Logic ---
    window.login = function() {
      currentUsername = document.getElementById("username-input").value.toLowerCase().trim();
      if (currentUsername === "") {
        showMessage("Please enter a username.", "error");
        return;
      }

      // Update username display in sections
      document.getElementById('admin-current-username').innerText = currentUsername;
      document.getElementById('tech-current-username').innerText = currentUsername;

      if (currentUsername === "admin") {
        showPage('admin-section');
        chargerToutesTaches(); // Load all tasks for admin
      } else {
        document.getElementById('user-page-title').innerText = `üë∑‚Äç‚ôÇÔ∏è T√¢ches pour ${currentUsername.charAt(0).toUpperCase() + currentUsername.slice(1)}`;
        showPage('user-section');
        chargerMesTaches(currentUsername); // Load tasks for the specific technician
      }
      showMessage(`Welcome, ${currentUsername}!`, "success");
    };

    // --- Task Management Functions ---

    // Add a new task to Google Sheet
    window.ajouterTache = async function() {
      const dateInput = document.getElementById('date');
      const techInput = document.getElementById('tech');
      const taskInput = document.getElementById('task');

      const taskData = {
        date: dateInput.value,
        tech: techInput.value,
        task: taskInput.value
      };

      if (!taskData.date || !taskData.tech || !taskData.task) {
        showMessage("Please fill in all fields (Date, Technician, Task).", "error");
        return;
      }

      try {
        const response = await fetch(API_URL + "?action=add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(taskData)
        });
        const result = await response.text(); // Your Apps Script returns plain text
        if (response.ok) {
          showMessage("Task added successfully!", "success");
          dateInput.value = ''; // Clear inputs
          techInput.value = '';
          taskInput.value = '';
          chargerToutesTaches(); // Refresh admin's task list
        } else {
          console.error("Error adding task:", result);
          showMessage("Error adding task: " + result, "error");
        }
      } catch (e) {
        console.error("Network or script error adding task: ", e);
        showMessage("Network error. Could not add task.", "error");
      }
    };

    // Load all tasks for Admin section
    async function chargerToutesTaches() {
      const ul = document.getElementById("all-tasks-list");
      ul.innerHTML = '<li class="text-gray-500 text-center p-4">Loading all tasks...</li>'; // Show loading

      try {
        const response = await fetch(API_URL + "?action=list", { method: "POST" });
        const data = await response.json(); // Your Apps Script returns JSON

        ul.innerHTML = ""; // Clear existing list items

        // Filter out header row (first element) and display tasks
        data.slice(1).forEach(row => {
          const li = document.createElement("li");
          li.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
          // Assuming row format: [Date, Technicien, T√¢che, Statut]
          li.innerHTML = `
            <div class="flex-grow">
              <p class="font-semibold text-blue-700">${row[0] || 'N/A'} | ${row[1] || 'N/A'}</p>
              <p class="text-gray-800">${row[2] || 'N/A'}</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
              Status: <span class="font-bold ${row[3] === 'Fait' ? 'text-green-600' : 'text-red-600'}">${row[3] || 'N/A'}</span>
            </div>
          `;
          ul.appendChild(li);
        });

        if (data.length <= 1) { // Only header row or no data
          ul.innerHTML = '<li class="text-gray-500 text-center p-4">No tasks found.</li>';
        }
      } catch (e) {
        console.error("Error loading all tasks: ", e);
        showMessage("Error loading all tasks. Check console.", "error");
        ul.innerHTML = '<li class="text-red-500 text-center p-4">Failed to load tasks.</li>';
      }
    }

    // Load tasks for specific technician
    async function chargerMesTaches(user) {
      const ul = document.getElementById("my-tasks-list");
      ul.innerHTML = '<li class="text-gray-500 text-center p-4">Loading your tasks...</li>'; // Show loading

      try {
        // Updated call to fetch data with original row index
        const response = await fetch(API_URL + "?action=userTasks&tech=" + encodeURIComponent(user), { method: "POST" });
        const tasks = await response.json(); // Now expects an array of objects

        ul.innerHTML = ""; // Clear existing list items

        tasks.forEach(task => {
          const li = document.createElement("li");
          li.className = 'bg-gray-100 p-3 rounded-lg mb-2 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
          
          li.innerHTML = `
            <div class="flex-grow">
              <p class="font-semibold text-green-700">${task.date || 'N/A'}</p>
              <p class="text-gray-800">${task.task || 'N/A'}</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0 sm:ml-4">
              Status: <span class="font-bold ${task.status === 'Fait' ? 'text-green-600' : 'text-red-600'}">${task.status || 'N/A'}</span>
            </div>
          `;
          
          if (task.status !== "Fait") {
            const btn = document.createElement("button");
            btn.innerText = "‚úÖ Terminer";
            btn.className = 'ml-4 bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-full text-sm transition duration-300 ease-in-out';
            // Use the original rowIndex from the Apps Script response
            btn.onclick = async () => {
              await markTaskDone(task.rowIndex);
              chargerMesTaches(user); // Refresh technician's tasks after marking done
            };
            li.appendChild(btn);
          }
          ul.appendChild(li);
        });

        if (tasks.length === 0) {
          ul.innerHTML = '<li class="text-gray-500 text-center p-4">No tasks assigned to you.</li>';
        }
      } catch (e) {
        console.error("Error loading technician tasks: ", e);
        showMessage("Error loading your tasks. Check console.", "error");
        ul.innerHTML = '<li class="text-red-500 text-center p-4">Failed to load tasks.</li>';
      }
    }

    // Mark task as done
    window.markTaskDone = async function(rowIndex) {
      try {
        const response = await fetch(API_URL + "?action=done&row=" + rowIndex, { method: "POST" });
        const result = await response.text();
        if (response.ok) {
          showMessage("Task marked as completed!", "success");
          // Refresh technician's tasks is handled by chargerMesTaches after button click
        } else {
          console.error("Error marking task done:", result);
          showMessage("Error marking task done: " + result, "error");
        }
      } catch (e) {
        console.error("Network or script error marking task done: ", e);
        showMessage("Network error. Could not mark task done.", "error");
      }
    };

    // --- Initial Load ---
    window.onload = function() {
      showPage('login-section'); // Always start with the login page
    };

    // --- Logout Function ---
    window.goToLogin = function() {
      currentUsername = ""; // Clear logged-in username
      document.getElementById("username-input").value = ""; // Clear input field
      showPage('login-section');
      showMessage("Logged out successfully.", "info");
    };
  </script>
</body>
</html>
