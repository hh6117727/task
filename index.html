<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Tâches</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Connexion -->
  <div id="loginForm" class="bg-white p-6 rounded shadow-md w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">🔐 Connexion</h2>
    <input type="text" id="username" placeholder="Nom d'utilisateur" class="border p-2 w-full mb-2" />
    <input type="password" id="password" placeholder="Mot de passe" class="border p-2 w-full mb-4" />
    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Se connecter</button>
    <p id="loginError" class="text-red-500 mt-2 hidden">Identifiants invalides</p>
  </div>

  <!-- Panneau admin -->
  <div id="adminPanel" class="hidden bg-white p-6 rounded shadow-md w-full max-w-2xl mt-6">
    <h2 class="text-xl font-bold mb-4">👤 Panneau Administrateur</h2>

    <h3 class="font-semibold mb-1">Ajouter une tâche :</h3>
    <div class="flex gap-2 mb-4">
      <input type="date" id="taskDate" class="border p-2 w-1/3" />
      <input type="text" id="taskTechnicien" placeholder="Nom du technicien" class="border p-2 w-1/3" />
      <input type="text" id="taskDesc" placeholder="Description de tâche" class="border p-2 w-1/3" />
    </div>
    <button onclick="addTask()" class="bg-green-500 text-white px-4 py-2 rounded mb-6">➕ Ajouter tâche</button>

    <h3 class="font-semibold mb-1">Ajouter utilisateur :</h3>
    <div class="flex gap-2 mb-4">
      <input type="text" id="newUsername" placeholder="Nom" class="border p-2 w-1/3" />
      <input type="text" id="newPassword" placeholder="Mot de passe" class="border p-2 w-1/3" />
      <select id="newRole" class="border p-2 w-1/3">
        <option value="admin">Admin</option>
        <option value="technicien">Technicien</option>
      </select>
    </div>
    <button onclick="addUser()" class="bg-purple-500 text-white px-4 py-2 rounded">➕ Ajouter utilisateur</button>
  </div>

  <!-- Panneau technicien -->
  <div id="techPanel" class="hidden bg-white p-6 rounded shadow-md w-full max-w-2xl mt-6">
    <h2 class="text-xl font-bold mb-4">📋 Mes Tâches</h2>
    <ul id="taskList" class="space-y-2"></ul>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz0QW_iHnN-szxYWWtq19uPL3TnpjjXbp6kma5bdLrVyZIeuQ8mZK1_iwISOgYd959A/exec";
    let currentUser = "";

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      const res = await fetch(API_URL, {
        method: "POST",
        body: new URLSearchParams({ action: "login", username, password }),
      });
      const data = await res.json();

      if (data.success) {
        currentUser = username;
        document.getElementById("loginForm").classList.add("hidden");

        if (data.role === "admin") {
          document.getElementById("adminPanel").classList.remove("hidden");
        } else {
          document.getElementById("techPanel").classList.remove("hidden");
          getTasks();
        }
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    async function addTask() {
      const date = document.getElementById("taskDate").value;
      const technicien = document.getElementById("taskTechnicien").value;
      const task = document.getElementById("taskDesc").value;

      await fetch(API_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "addTask",
          date,
          technicien,
          task
        }),
      });
      alert("✅ Tâche ajoutée !");
    }

    async function addUser() {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;

      await fetch(API_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "addUser",
          username,
          password,
          role
        }),
      });
      alert("👤 Utilisateur ajouté !");
    }

    async function getTasks() {
      const res = await fetch(API_URL, {
        method: "POST",
        body: new URLSearchParams({ action: "getTasks", technicien: currentUser }),
      });
      const data = await res.json();

      const list = document.getElementById("taskList");
      list.innerHTML = "";

      data.tasks.forEach((task) => {
        const li = document.createElement("li");
        li.className = "border p-2 flex justify-between items-center";
        li.innerHTML = `
          <span>${task.date} - ${task.task} (${task.status})</span>
          ${task.status !== "Complétée" ? `<button onclick="completeTask('${task.date}','${task.task}')" class="bg-blue-500 text-white px-2 py-1 rounded">✅ Terminer</button>` : ""}
        `;
        list.appendChild(li);
      });
    }

    async function completeTask(date, task) {
      await fetch(API_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "completeTask",
          date,
          technicien: currentUser,
          task
        }),
      });
      alert("🎉 Tâche complétée !");
      getTasks();
    }
  </script>
</body>
</html>
